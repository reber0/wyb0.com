<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="thinkphp 的 where 函数可以接收字符串和数组，接收字符串时就可能存在注入，还是使用数组来传值吧。。。"/>
  <meta name="author" content="Reber"/>
  
    
      <title>ThinkPHP5 的 where 函数使用不当存在注入 | Reber&#39;s Blog</title>
    
  
  <link rel="stylesheet" href="/css/reset.css"/>
  
  <link rel="stylesheet" href="/css/smigle.css"/>
  
    <link rel="stylesheet" href="/css/monokai-sublime.min.css"/>
  
    <link rel="stylesheet" href="/css/style.css"/>
  
  
    <script src="/js/jquery-3.6.0.min.js"/></script>
  
    <script src="/js/highlight.min.js"/></script>
  
    <script src="/js/style.js"/></script>
  
  <link rel="icon" type="image/img" sizes="16x16" href="/img/logo.png">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="theme-color" content="#ffffff">
</head>

  <body>
    <header>
  <div id="brand">
    <a class="icon-link" href="https://wyb0.com/">
      <img
        class="icon"
        src="/img/logo.png"
      />
    </a>
    <div class="text">
      <a href="https://wyb0.com/"><h1>Reber&#39;s Blog</h1></a>
      <h3>只会一点点编程、只会一点点渗透</h3>
    </div>
  </div>
  <nav>
    
      
        
        <a href="/"><b>Home</b></a>
      
         | 
        <a href="/posts/"><b>Posts</b></a>
      
         | 
        <a href="/categories/"><b>Categories</b></a>
      
         | 
        <a href="/tags/"><b>Tags</b></a>
      
         | 
        <a href="/about/"><b>About</b></a>
      
         | 
        <a href="/friends/"><b>Friends</b></a>
      
    
  </nav>
  <hr />
</header>

    <div id="content">
      
  <main>
    <article>
      <h1>ThinkPHP5 的 where 函数使用不当存在注入</h1>
      
<div class="post-meta">
    <time>2018-04-16</time>
    
    [<a href="/categories/Pentest">Pentest</a>,<a href="/categories/PHP">PHP</a>](<a href="/tags/SQL%E6%B3%A8%E5%85%A5">SQL注入</a>,<a href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1">代码审计</a>)
</div>

      <div><h3 id="0x00-关于thinkphp5的where函数">0x00 关于thinkphp5的where函数</h3>
<p>年前公司委托别的公司开发一个网站，使用的是ThinkPHP 5.0.13，存在一个注入漏洞，分析后发现是因为tp5中的where函数使用不当，tp5中where这个函数可以接收字符串和数组这两种类型的参数来进行查询，而在用字符串这种传递方式时，如果使用不当的话就可能会出现sql注入。</p>
<h3 id="0x01-示例代码">0x01 示例代码</h3>
<p>tp5/application/home/controller/Index.php</p>
<pre tabindex="0"><code>&lt;?php
namespace app\home\controller;

use think\Db;

class Index
{   
    //http://127.0.0.1/Source/tp5/home/index/testdb/id/1
    public function testDb()
    {
        // 调用 tp5/thinkphp/library/think/Db.php 的 connect() 函数 初始化数据库，并取得数据库类实例
        $msg = db(&#39;msg&#39;);

        $id = input(&#39;param.id&#39;,1); //不存在id的话默认为1

        //在Db.php中use think\db\Query; $msg-&gt;where()则调用了Query.php中的where函数进入查询流程
        $result = $msg-&gt;where(&#34;id=&#34;.$id)-&gt;select();
        // $result = $msg-&gt;where([&#39;id&#39;=&gt;$id])-&gt;select();

        echo &#39;&lt;br/&gt;&lt;hr/&gt;执行的sql语句：&#39;;
        echo $msg-&gt;getLastSql();
        echo &#39;&lt;br/&gt;最终得到的结果：&#39;;
        echo var_dump($result);
    }
}
</code></pre><p>where函数接收字符串和数组时，访问<code>http://127.0.0.1/Source/tp5/home/index/testdb/id/1</code>执行的SQL语句分别如下：</p>
<pre tabindex="0"><code>SELECT * FROM `msg` WHERE ( id=1 )

SELECT * FROM `msg` WHERE `id` = 1
</code></pre><p>前者存在注入，当payload为: <!-- raw HTML omitted -->) and 1=1 and (1)=(1<!-- raw HTML omitted -->时判断返回如下：
<img src="/img/post/tp5_where_str1.png" alt="80">
<img src="/img/post/tp5_where_str2.png" alt="45">
主要调用文件及函数顺序如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span>调用 tp5/thinkphp/library/think/Db.php 的 connect() 函数 初始化数据库，并取得数据库类实例
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>调用 tp5/thinkphp/library/think/db/Query.php 的 __construct() 函数
</span></span><span style="display:flex;"><span>    ==&gt;调用 tp5/thinkphp/library/think/db/Builder.php 的 __construct() 函数
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>调用 tp5/thinkphp/library/think/db/Query.php 的 where() 函数
</span></span><span style="display:flex;"><span>调用 tp5/thinkphp/library/think/db/Query.php 的 select() 函数
</span></span><span style="display:flex;"><span>    ==&gt;调用 tp5/thinkphp/library/think/db/Query.php 的 parseExpress 函数进行相关解析
</span></span><span style="display:flex;"><span>    ==&gt;调用 tp5/thinkphp/library/think/db/Builder.php 的 select() 函数得到最终执行的sql语句
</span></span><span style="display:flex;"><span>    ==&gt;调用 tp5/thinkphp/library/think/db/Query.php 的 query() 函数
</span></span></code></pre></div><h3 id="0x02-调用流程中where的处理">0x02 调用流程中where的处理</h3>
<ul>
<li>tp5/thinkphp/library/think/db/Query.php 的 where()</li>
</ul>
<pre tabindex="0"><code>//指定AND查询条件
public function where($field, $op = null, $condition = null)
{
    $param = func_get_args(); //array(1) { [0]=&gt; string(24) &#34;id=1) and 1=1 and (1)=(1&#34; } 
    array_shift($param); //array(0) { } 
    $this-&gt;parseWhereExp(&#39;AND&#39;, $field, $op, $condition, $param);
    return $this;
}

//分析查询表达式
protected function parseWhereExp($logic, $field, $op, $condition, $param = [])
{
    //$logic=&#39;AND&#39;
    //$field=&#34;id=1) and 1=1 and (1)=(1&#34;
    $logic = strtoupper($logic);
    if ($field instanceof \Closure) {
        $this-&gt;options[&#39;where&#39;][$logic][] = is_string($op) ? [$op, $field] : $field;
        return;
    }

    if (is_string($field) &amp;&amp; !empty($this-&gt;options[&#39;via&#39;]) &amp;&amp; !strpos($field, &#39;.&#39;)) {
        $field = $this-&gt;options[&#39;via&#39;] . &#39;.&#39; . $field;
    }

    if (is_string($field) &amp;&amp; preg_match(&#39;/[,=\&gt;\&lt;\&#39;\&#34;\(\s]/&#39;, $field)) {//进入
        $where[] = [&#39;exp&#39;, $field];
        // echo &#39;&lt;pre&gt;&#39;;
        // var_dump($where);
        // echo &#39;&lt;pre&gt;&#39;;
        if (is_array($op)) {//跳出
            // 参数绑定
            $this-&gt;bind($op);
        }
    } elseif (is_null($op) &amp;&amp; is_null($condition)) {
        if (is_array($field)) {
            // 数组批量查询
            $where = $field;
            foreach ($where as $k =&gt; $val) {
                $this-&gt;options[&#39;multi&#39;][$logic][$k][] = $val;
            }
        } elseif ($field &amp;&amp; is_string($field)) {
            // 字符串查询
            $where[$field]                            = [&#39;null&#39;, &#39;&#39;];
            $this-&gt;options[&#39;multi&#39;][$logic][$field][] = $where[$field];
        }
    } elseif (is_array($op)) {
        $where[$field] = $param;
    } elseif (in_array(strtolower($op), [&#39;null&#39;, &#39;notnull&#39;, &#39;not null&#39;])) {
        // null查询
        $where[$field]                            = [$op, &#39;&#39;];
        $this-&gt;options[&#39;multi&#39;][$logic][$field][] = $where[$field];
    } elseif (is_null($condition)) {
        // 字段相等查询
        $where[$field]                            = [&#39;eq&#39;, $op];
        $this-&gt;options[&#39;multi&#39;][$logic][$field][] = $where[$field];
    } else {
        $where[$field] = [$op, $condition, isset($param[2]) ? $param[2] : null];
        if (&#39;exp&#39; == strtolower($op) &amp;&amp; isset($param[2]) &amp;&amp; is_array($param[2])) {
            // 参数绑定
            $this-&gt;bind($param[2]);
        }
        // 记录一个字段多次查询条件
        $this-&gt;options[&#39;multi&#39;][$logic][$field][] = $where[$field];
    }
    if (!empty($where)) {//进入
        if (!isset($this-&gt;options[&#39;where&#39;][$logic])) {//进入
            $this-&gt;options[&#39;where&#39;][$logic] = [];
        }
        if (is_string($field) &amp;&amp; $this-&gt;checkMultiField($field, $logic)) {
            $where[$field] = $this-&gt;options[&#39;multi&#39;][$logic][$field];
        } elseif (is_array($field)) {
            foreach ($field as $key =&gt; $val) {
                if ($this-&gt;checkMultiField($key, $logic)) {
                    $where[$key] = $this-&gt;options[&#39;multi&#39;][$logic][$key];
                }
            }
        }
        $this-&gt;options[&#39;where&#39;][$logic] = array_merge($this-&gt;options[&#39;where&#39;][$logic], $where);
        //array(1) { [0]=&gt; array(2) { [0]=&gt; string(3) &#34;exp&#34; [1]=&gt; string(24) &#34;id=1) and 1=1 and (1)=(1&#34; } } 
    }
}
</code></pre><p>Query.php这里面经过where和parseWhereExp的处理后把数组存入了<code>options['where'][$logic]</code>里面</p>
<p>不过这里处理后我们拼接的数据没有变，这样where()就处理好了，接着调用select()</p>
<h3 id="0x03-调用流程中select的处理这里就query得到结果了">0x03 调用流程中select的处理(这里就query得到结果了)</h3>
<p>流程的话分三步：</p>
<p>1、解析参数：在tp5/thinkphp/library/db/Query.php的select()函数中调用$this-&gt;parseExpress(); 进行表达式的解析</p>
<p>2、生成sql语句：在tp5/thinkphp/library/db/Query.php的select()函数中调用Builder.php里的select()处理上面解析后的参数最终生成sql语句</p>
<p>3、执行sql语句：在tp5/thinkphp/library/db/Query.php的select()函数中调用$this-&gt;query()得到结果</p>
<ul>
<li>解析参数(tp5/thinkphp/library/db/Query.php)</li>
</ul>
<pre tabindex="0"><code>//查找记录
public function select($data = null)
{
    if ($data instanceof Query) {
        return $data-&gt;select();
    } elseif ($data instanceof \Closure) {
        call_user_func_array($data, [ &amp; $this]);
        $data = null;
    }
    // 分析查询表达式
    $options = $this-&gt;parseExpress();//分析了表达式，把查的表、查的列、查询条件都存到$options

    if (false === $data) {
        // 用于子查询 不查询只返回SQL
        $options[&#39;fetch_sql&#39;] = true;
    } elseif (!is_null($data)) {
        // 主键条件分析
        $this-&gt;parsePkWhere($data, $options);
    }

    $resultSet = false;
    if (empty($options[&#39;fetch_sql&#39;]) &amp;&amp; !empty($options[&#39;cache&#39;])) {
        // 判断查询缓存
        $cache = $options[&#39;cache&#39;];
        unset($options[&#39;cache&#39;]);
        $key       = is_string($cache[&#39;key&#39;]) ? $cache[&#39;key&#39;] : md5(serialize($options) . serialize($this-&gt;bind));
        $resultSet = Cache::get($key);
    }
    if (false === $resultSet) {//进入
        // 生成查询SQL
        //这里调用tp5/thinkphp/library/db/Builder.php里的select()处理，生成sql语句如下：
        //$sql = &#34;SELECT * FROM `msg` WHERE  (  id=1) and 1=1 and (1)=(1)&#34;
        $sql = $this-&gt;builder-&gt;select($options);
        //echo &#34;&lt;br&gt;最终生成的sql语句：&#34;.$sql.&#34;&lt;br&gt;&#34;;

        // 获取参数绑定
        $bind = $this-&gt;getBind();
        if ($options[&#39;fetch_sql&#39;]) {//跳过
            // 获取实际执行的SQL语句
            return $this-&gt;connection-&gt;getRealSql($sql, $bind);
        }

        $options[&#39;data&#39;] = $data;//$data是空的

        if ($resultSet = $this-&gt;trigger(&#39;before_select&#39;, $options)) {
        } else {//进入，这里就执行了sql查询操作了，造成注入
            // 执行查询操作
            //调用 tp5/thinkphp/library/think/db/Connection.php 的 query() 函数
            $resultSet = $this-&gt;query($sql, $bind, $options[&#39;master&#39;], $options[&#39;fetch_pdo&#39;]);

            if ($resultSet instanceof \PDOStatement) {
                // 返回PDOStatement对象
                return $resultSet;
            }
        }

        if (isset($cache) &amp;&amp; false !== $resultSet) {
            // 缓存数据集
            $this-&gt;cacheData($key, $resultSet, $cache);
        }
    }

    /*
    省略部分代码
    */

    // 返回结果处理
    if (!empty($options[&#39;fail&#39;]) &amp;&amp; count($resultSet) == 0) {
        $this-&gt;throwNotFound($options);
    }
    // var_dump($resultSet);
    return $resultSet;
}

//分析表达式（可用于查询或者写入操作）
protected function parseExpress()
{
    $options = $this-&gt;options;//将where()处理后的数据给options

    // 获取数据表
    if (empty($options[&#39;table&#39;])) {//进入，得到查询的表名
        $options[&#39;table&#39;] = $this-&gt;getTable(); //string(3) &#34;msg&#34; 
    }

    if (!isset($options[&#39;where&#39;])) {
        $options[&#39;where&#39;] = [];
    } elseif (isset($options[&#39;view&#39;])) {
        // 视图查询条件处理
        foreach ([&#39;AND&#39;, &#39;OR&#39;] as $logic) {
            if (isset($options[&#39;where&#39;][$logic])) {
                foreach ($options[&#39;where&#39;][$logic] as $key =&gt; $val) {
                    if (array_key_exists($key, $options[&#39;map&#39;])) {
                        $options[&#39;where&#39;][$logic][$options[&#39;map&#39;][$key]] = $val;
                        unset($options[&#39;where&#39;][$logic][$key]);
                    }
                }
            }
        }

        if (isset($options[&#39;order&#39;])) {
            // 视图查询排序处理
            if (is_string($options[&#39;order&#39;])) {
                $options[&#39;order&#39;] = explode(&#39;,&#39;, $options[&#39;order&#39;]);
            }
            foreach ($options[&#39;order&#39;] as $key =&gt; $val) {
                if (is_numeric($key)) {
                    if (strpos($val, &#39; &#39;)) {
                        list($field, $sort) = explode(&#39; &#39;, $val);
                        if (array_key_exists($field, $options[&#39;map&#39;])) {
                            $options[&#39;order&#39;][$options[&#39;map&#39;][$field]] = $sort;
                            unset($options[&#39;order&#39;][$key]);
                        }
                    } elseif (array_key_exists($val, $options[&#39;map&#39;])) {
                        $options[&#39;order&#39;][$options[&#39;map&#39;][$val]] = &#39;asc&#39;;
                        unset($options[&#39;order&#39;][$key]);
                    }
                } elseif (array_key_exists($key, $options[&#39;map&#39;])) {
                    $options[&#39;order&#39;][$options[&#39;map&#39;][$key]] = $val;
                    unset($options[&#39;order&#39;][$key]);
                }
            }
        }
    }

    if (!isset($options[&#39;field&#39;])) {//进入，设置查询的列名为*
        $options[&#39;field&#39;] = &#39;*&#39;;
    }

    if (!isset($options[&#39;data&#39;])) {//进入
        $options[&#39;data&#39;] = [];
    }

    if (!isset($options[&#39;strict&#39;])) {//进入，bool(true)
        $options[&#39;strict&#39;] = $this-&gt;getConfig(&#39;fields_strict&#39;);
    }

    foreach ([&#39;master&#39;, &#39;lock&#39;, &#39;fetch_pdo&#39;, &#39;fetch_sql&#39;, &#39;distinct&#39;] as $name) {
        if (!isset($options[$name])) {//进入，$options[$name]置为false
            $options[$name] = false;
        }
    }

    foreach ([&#39;join&#39;, &#39;union&#39;, &#39;group&#39;, &#39;having&#39;, &#39;limit&#39;, &#39;order&#39;, &#39;force&#39;, &#39;comment&#39;] as $name) {
        if (!isset($options[$name])) {//进入，$options[$name]置为&#39;&#39;
            $options[$name] = &#39;&#39;;
        }
    }

    if (isset($options[&#39;page&#39;])) {
        // 根据页数计算limit
        list($page, $listRows) = $options[&#39;page&#39;];
        $page                  = $page &gt; 0 ? $page : 1;
        $listRows              = $listRows &gt; 0 ? $listRows : (is_numeric($options[&#39;limit&#39;]) ? $options[&#39;limit&#39;] : 20);
        $offset                = $listRows * ($page - 1);
        $options[&#39;limit&#39;]      = $offset . &#39;,&#39; . $listRows;
    }

    $this-&gt;options = [];
    // echo &#39;&lt;pre&gt;&#39;;
    //     var_dump($options);
    // echo &#39;&lt;pre&gt;&#39;;
    return $options;
}
</code></pre><ul>
<li>生成SQL语句(tp5/thinkphp/library/db/Builder.php)</li>
</ul>
<pre tabindex="0"><code>//生成查询SQL
public function select($options = [])
{
    //这里主要分析一下$this-&gt;parseWhere($options[&#39;where&#39;], $options),
    $sql = str_replace(
        [&#39;%TABLE%&#39;, &#39;%DISTINCT%&#39;, &#39;%FIELD%&#39;, &#39;%JOIN%&#39;, &#39;%WHERE%&#39;, &#39;%GROUP%&#39;, &#39;%HAVING%&#39;, &#39;%ORDER%&#39;, &#39;%LIMIT%&#39;, &#39;%UNION%&#39;, &#39;%LOCK%&#39;, &#39;%COMMENT%&#39;, &#39;%FORCE%&#39;],
        [
            $this-&gt;parseTable($options[&#39;table&#39;], $options),
            $this-&gt;parseDistinct($options[&#39;distinct&#39;]),
            $this-&gt;parseField($options[&#39;field&#39;], $options),
            $this-&gt;parseJoin($options[&#39;join&#39;], $options),
            $this-&gt;parseWhere($options[&#39;where&#39;], $options),
            $this-&gt;parseGroup($options[&#39;group&#39;]),
            $this-&gt;parseHaving($options[&#39;having&#39;]),
            $this-&gt;parseOrder($options[&#39;order&#39;], $options),
            $this-&gt;parseLimit($options[&#39;limit&#39;]),
            $this-&gt;parseUnion($options[&#39;union&#39;]),
            $this-&gt;parseLock($options[&#39;lock&#39;]),
            $this-&gt;parseComment($options[&#39;comment&#39;]),
            $this-&gt;parseForce($options[&#39;force&#39;]),
        ], $this-&gt;selectSql);
    return $sql;
}

//where分析
protected function parseWhere($where, $options)
{
    $whereStr = $this-&gt;buildWhere($where, $options);//( id=1) and 1=1 and (1)=(1 )
    if (!empty($options[&#39;soft_delete&#39;])) {//跳过
        // 附加软删除条件
        list($field, $condition) = $options[&#39;soft_delete&#39;];

        $binds    = $this-&gt;query-&gt;getFieldsBind($options[&#39;table&#39;]);
        $whereStr = $whereStr ? &#39;( &#39; . $whereStr . &#39; ) AND &#39; : &#39;&#39;;
        $whereStr = $whereStr . $this-&gt;parseWhereItem($field, $condition, &#39;&#39;, $options, $binds);
    }
    return empty($whereStr) ? &#39;&#39; : &#39; WHERE &#39; . $whereStr;
}

//生成查询条件SQL
public function buildWhere($where, $options)
{
    if (empty($where)) {
        $where = [];
    }

    if ($where instanceof Query) {//跳过
        return $this-&gt;buildWhere($where-&gt;getOptions(&#39;where&#39;), $options);
    }

    $whereStr = &#39;&#39;;
    $binds    = $this-&gt;query-&gt;getFieldsBind($options[&#39;table&#39;]);
    //$binds 为 array(4) { [&#34;id&#34;]=&gt; int(1) [&#34;name&#34;]=&gt; int(2) [&#34;title&#34;]=&gt; int(2) [&#34;content&#34;]=&gt; int(2) }

    /*
    $where结构如下：
    array(1) {
      [&#34;AND&#34;]=&gt;
      array(1) {
        [0]=&gt;
        array(2) {
          [0]=&gt;
          string(3) &#34;exp&#34;
          [1]=&gt;
          string(24) &#34;id=1) and 1=1 and (1)=(1&#34;
        }
      }
    }
    */
    foreach ($where as $key =&gt; $val) {//$key为AND
        $str = [];
        foreach ($val as $field =&gt; $value) {//$field为0
            if ($value instanceof \Closure) {
                // 使用闭包查询
                $query = new Query($this-&gt;connection);
                call_user_func_array($value, [ &amp; $query]);
                $whereClause = $this-&gt;buildWhere($query-&gt;getOptions(&#39;where&#39;), $options);
                if (!empty($whereClause)) {
                    $str[] = &#39; &#39; . $key . &#39; ( &#39; . $whereClause . &#39; )&#39;;
                }
            } elseif (strpos($field, &#39;|&#39;)) {
                // 不同字段使用相同查询条件（OR）
                $array = explode(&#39;|&#39;, $field);
                $item  = [];
                foreach ($array as $k) {
                    $item[] = $this-&gt;parseWhereItem($k, $value, &#39;&#39;, $options, $binds);
                }
                $str[] = &#39; &#39; . $key . &#39; ( &#39; . implode(&#39; OR &#39;, $item) . &#39; )&#39;;
            } elseif (strpos($field, &#39;&amp;&#39;)) {
                // 不同字段使用相同查询条件（AND）
                $array = explode(&#39;&amp;&#39;, $field);
                $item  = [];
                foreach ($array as $k) {
                    $item[] = $this-&gt;parseWhereItem($k, $value, &#39;&#39;, $options, $binds);
                }
                $str[] = &#39; &#39; . $key . &#39; ( &#39; . implode(&#39; AND &#39;, $item) . &#39; )&#39;;
            } else {//进入
                // 对字段使用表达式查询
                $field = is_string($field) ? $field : &#39;&#39;;//$field为&#39;&#39;

                /*
                * 传递到parseWhereItem的参数如下：
                * $field为 &#39;&#39;
                * $value为 array(2) { [0]=&gt; string(3) &#34;exp&#34; [1]=&gt; string(24) &#34;id=1) and 1=1 and (1)=(1&#34; }
                *   $key为 AND
                * $binds为 array(4) { [&#34;id&#34;]=&gt; int(1) [&#34;name&#34;]=&gt; int(2) [&#34;title&#34;]=&gt; int(2) [&#34;content&#34;]=&gt; int(2) }
                */
                $str[] = &#39; &#39; . $key . &#39; &#39; . $this-&gt;parseWhereItem($field, $value, $key, $options, $binds);
                // $str为array(1) { [0]=&gt; string(34) &#34; AND ( id=1) and 1=1 and (1)=(1 )&#34; } 
            }
        }
        
        //substr处理掉多出来的AND
        $whereStr .= empty($whereStr) ? substr(implode(&#39; &#39;, $str), strlen($key) + 1) : implode(&#39; &#39;, $str);
    }

    return $whereStr;//最后输出( id=1) and 1=1 and (1)=(1 )
}

// where子单元分析
protected function parseWhereItem($field, $val, $rule = &#39;&#39;, $options = [], $binds = [], $bindName = null)
{
    // 字段分析
    $key = $field ? $this-&gt;parseKey($field, $options) : &#39;&#39;;//$key为&#39;&#39;

    // 查询规则和条件
    if (!is_array($val)) {
        $val = is_null($val) ? [&#39;null&#39;, &#39;&#39;] : [&#39;=&#39;, $val];
    }
    list($exp, $value) = $val;//$exp为exp，$value为id=1) and 1=1 and (1)=(1

    // 对一个字段使用多个查询条件
    if (is_array($exp)) {
        $item = array_pop($val);
        // 传入 or 或者 and
        if (is_string($item) &amp;&amp; in_array($item, [&#39;AND&#39;, &#39;and&#39;, &#39;OR&#39;, &#39;or&#39;])) {
            $rule = $item;
        } else {
            array_push($val, $item);
        }
        foreach ($val as $k =&gt; $item) {
            $bindName = &#39;where_&#39; . str_replace(&#39;.&#39;, &#39;_&#39;, $field) . &#39;_&#39; . $k;
            $str[]    = $this-&gt;parseWhereItem($field, $item, $rule, $options, $binds, $bindName);
        }
        return &#39;( &#39; . implode(&#39; &#39; . $rule . &#39; &#39;, $str) . &#39; )&#39;;
    }

    // 检测操作符
    if (!in_array($exp, $this-&gt;exp)) {//进入，$exp的值从exp变为了EXP
        $exp = strtolower($exp);
        if (isset($this-&gt;exp[$exp])) {
            $exp = $this-&gt;exp[$exp];//$exp为EXP
        } else {
            throw new Exception(&#39;where express error:&#39; . $exp);
        }
    }
    $bindName = $bindName ?: &#39;where_&#39; . str_replace([&#39;.&#39;, &#39;-&#39;], &#39;_&#39;, $field);
    // $bindName 是 where_
    if (preg_match(&#39;/\W/&#39;, $bindName)) {
        // 处理带非单词字符的字段名
        $bindName = md5($bindName);
    }

    if (is_object($value) &amp;&amp; method_exists($value, &#39;__toString&#39;)) {
        // 对象数据写入
        $value = $value-&gt;__toString();
    }

    $bindType = isset($binds[$field]) ? $binds[$field] : PDO::PARAM_STR;
    //返回PDO::PARAM_STR，即数字2

    if (is_scalar($value) &amp;&amp; array_key_exists($field, $binds) &amp;&amp; !in_array($exp, [&#39;EXP&#39;, &#39;NOT NULL&#39;, &#39;NULL&#39;, &#39;IN&#39;, &#39;NOT IN&#39;, &#39;BETWEEN&#39;, &#39;NOT BETWEEN&#39;]) &amp;&amp; strpos($exp, &#39;TIME&#39;) === false) {
        if (strpos($value, &#39;:&#39;) !== 0 || !$this-&gt;query-&gt;isBind(substr($value, 1))) {
            if ($this-&gt;query-&gt;isBind($bindName)) {
                $bindName .= &#39;_&#39; . str_replace(&#39;.&#39;, &#39;_&#39;, uniqid(&#39;&#39;, true));
            }
            $this-&gt;query-&gt;bind($bindName, $value, $bindType);
            $value = &#39;:&#39; . $bindName;
        }
    }

    $whereStr = &#39;&#39;;
    if (in_array($exp, [&#39;=&#39;, &#39;&lt;&gt;&#39;, &#39;&gt;&#39;, &#39;&gt;=&#39;, &#39;&lt;&#39;, &#39;&lt;=&#39;])) {
        // 比较运算
        if ($value instanceof \Closure) {
            $whereStr .= $key . &#39; &#39; . $exp . &#39; &#39; . $this-&gt;parseClosure($value);
        } else {
            $whereStr .= $key . &#39; &#39; . $exp . &#39; &#39; . $this-&gt;parseValue($value, $field);
        }
    } elseif (&#39;LIKE&#39; == $exp || &#39;NOT LIKE&#39; == $exp) {
        // 模糊匹配
        if (is_array($value)) {
            foreach ($value as $item) {
                $array[] = $key . &#39; &#39; . $exp . &#39; &#39; . $this-&gt;parseValue($item, $field);
            }
            $logic = isset($val[2]) ? $val[2] : &#39;AND&#39;;
            $whereStr .= &#39;(&#39; . implode($array, &#39; &#39; . strtoupper($logic) . &#39; &#39;) . &#39;)&#39;;
        } else {
            $whereStr .= $key . &#39; &#39; . $exp . &#39; &#39; . $this-&gt;parseValue($value, $field);
        }
    } elseif (&#39;EXP&#39; == $exp) {//进入
        // 表达式查询
        //$key为&#39;&#39;，$value为id=1) and 1=1 and (1)=(1
        //到此结束，$whereStr为(  id=1) and 1=1 and (1)=(1 )
        $whereStr .= &#39;( &#39; . $key . &#39; &#39; . $value . &#39; )&#39;;

    } elseif (in_array($exp, [&#39;NOT NULL&#39;, &#39;NULL&#39;])) {
        // NULL 查询
        $whereStr .= $key . &#39; IS &#39; . $exp;
    } elseif (in_array($exp, [&#39;BETWEEN TIME&#39;, &#39;NOT BETWEEN TIME&#39;])) {
        if (is_string($value)) {
            $value = explode(&#39;,&#39;, $value);
        }

        $whereStr .= $key . &#39; &#39; . substr($exp, 0, -4) . $this-&gt;parseDateTime($value[0], $field, $options, $bindName . &#39;_between_1&#39;, $bindType) . &#39; AND &#39; . $this-&gt;parseDateTime($value[1], $field, $options, $bindName . &#39;_between_2&#39;, $bindType);
    }
    // var_dump($whereStr);
    return $whereStr;
}
</code></pre><ul>
<li>执行sql语句(tp5/thinkphp/library/db/Query.php)</li>
</ul>
<pre tabindex="0"><code>//执行查询 返回数据集
public function query($sql, $bind = [], $master = false, $class = false)
{
    return $this-&gt;connection-&gt;query($sql, $bind, $master, $class);
}
</code></pre></div>
    </article>
  </main>

    </div>
    <footer>
  <hr />
  
    <p id="social">
      Find me around the web:
      
        
        <a href="https://github.com/reber0?_blank">GitHub</a>
      
         • 
        <a href="https://weibo.com/u/5819760166?_blank">Weibo</a>
      
    </p>
  
  <p class="copyright">
    Copyright © 2015-2023
    <a href="https://wyb0.com/"><strong>Reber</strong></a>.

    Built with
    <a href="http://www.gohugo.io/">Hugo</a>,
    based on the theme
    <a href="https://gitlab.com/ian-s-mcb/smigle-hugo-theme">smigle</a>.
  </p>
</footer>

  </body>
</html>
